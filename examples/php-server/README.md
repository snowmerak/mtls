# PHP mTLS Server Example

A simple HTTPS server with mutual TLS authentication using PHP's built-in server and stream contexts.

## Features

- ✅ Mutual TLS authentication
- ✅ Client certificate verification
- ✅ RESTful API endpoints
- ✅ No external dependencies
- ✅ Uses PHP built-in server

## Prerequisites

- PHP 7.4+ with OpenSSL support
- Certificates generated by the mtls CLI tool

## Setup

No dependencies needed! PHP's built-in server and OpenSSL extension are sufficient.

Check if OpenSSL is enabled:
```bash
php -m | grep openssl
```

## Running the Server

```bash
# Make run script executable
chmod +x run.sh

# Run the server
./run.sh

# Or manually
php -S localhost:8443 -t . server.php
```

The server will start on `https://localhost:8443`.

**Note:** PHP's built-in server doesn't fully support mTLS client certificate verification in the same way as Apache/Nginx. For production use, configure Apache or Nginx with mod_ssl or ssl_module.

## Endpoints

- `GET /` - Main endpoint with client certificate info
- `GET /health` - Health check endpoint
- `GET /api/data` - Sample data endpoint
- `POST /api/echo` - Echo back the request body

## Production Setup

For production, use Apache or Nginx:

### Apache Configuration

```apache
<VirtualHost *:8443>
    DocumentRoot /path/to/php-server
    
    SSLEngine on
    SSLCertificateFile /path/to/server-cert.pem
    SSLCertificateKeyFile /path/to/server-key.pem
    SSLCACertificateFile /path/to/ca-cert.pem
    
    SSLVerifyClient require
    SSLVerifyDepth 3
    
    SSLOptions +StdEnvVars +ExportCertData
</VirtualHost>
```

### Nginx Configuration

```nginx
server {
    listen 8443 ssl;
    server_name localhost;
    
    ssl_certificate /path/to/server-cert.pem;
    ssl_certificate_key /path/to/server-key.pem;
    ssl_client_certificate /path/to/ca-cert.pem;
    ssl_verify_client on;
    
    root /path/to/php-server;
    index server.php;
    
    location / {
        try_files $uri $uri/ /server.php?$query_string;
    }
    
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        fastcgi_index server.php;
        include fastcgi_params;
        fastcgi_param SSL_CLIENT_S_DN_CN $ssl_client_s_dn_cn;
        fastcgi_param SSL_CLIENT_VERIFY $ssl_client_verify;
    }
}
```

## Client Certificate Access

In the code, access client certificate info via:
```php
$clientCN = $_SERVER['SSL_CLIENT_S_DN_CN'];
$clientOrg = $_SERVER['SSL_CLIENT_S_DN_O'];
$verified = $_SERVER['SSL_CLIENT_VERIFY'] === 'SUCCESS';
```

## Testing

Test with curl:
```bash
curl --cert ../../certs/servers/localhost/server-cert.pem \
     --key ../../certs/servers/localhost/server-key.pem \
     --cacert ../../certs/ca/ca-cert.pem \
     https://localhost:8443/
```

Or use the PHP client:
```bash
cd ../php-client
./run.sh
```

## Limitations

PHP's built-in server has limitations:
- Single-threaded (one request at a time)
- Not suitable for production
- Limited SSL/TLS configuration
- Client certificate verification is limited

For development and testing only! Use Apache/Nginx for production.
