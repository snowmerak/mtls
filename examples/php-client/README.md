# PHP mTLS Client Example

A simple HTTPS client with mutual TLS authentication using PHP's stream contexts.

## Features

- âœ… Mutual TLS authentication
- âœ… Server certificate verification
- âœ… Multiple endpoint tests
- âœ… No external dependencies
- âœ… Pretty printed JSON output

## Prerequisites

- PHP 7.4+ with OpenSSL support
- Certificates generated by the mtls CLI tool
- Running mTLS server (PHP, Python, Node.js, Go, or Caddy)

## Setup

No dependencies needed! PHP's built-in functions and OpenSSL extension are sufficient.

Check if OpenSSL is enabled:
```bash
php -m | grep openssl
```

## Running the Client

```bash
# Make run script executable
chmod +x run.sh

# Run the client
./run.sh

# Or manually
php client.php
```

## What It Tests

The client tests 4 endpoints:

1. **GET /** - Main endpoint, displays client certificate info
2. **GET /health** - Health check endpoint
3. **GET /api/data** - Fetches sample data with metadata
4. **POST /api/echo** - Sends JSON and receives echo response

## Certificate Loading

The client uses stream contexts for SSL:

```php
$context = stream_context_create([
    'ssl' => [
        'local_cert' => 'server-cert.pem',
        'local_pk' => 'server-key.pem',
        'cafile' => 'ca-cert.pem',
        'verify_peer' => true,
        'verify_peer_name' => true,
        'allow_self_signed' => false,
    ]
]);
```

## Configuration

You can modify the server URL in `client.php`:
```php
$serverUrl = 'https://localhost:8443';
```

## Example Output

```
ðŸ”’ mTLS PHP Client
==================

ðŸ“¡ Test 1: Main endpoint (GET /)
âœ… Status: 200
   Message: mTLS PHP Server
   Client Certificate: localhost
   Verified: true
   Server Time: 2024-01-15T10:30:00+00:00

ðŸ“¡ Test 2: Health check (GET /health)
âœ… Status: 200
   Response: OK

ðŸ“¡ Test 3: API data (GET /api/data)
âœ… Status: 200
   Data:
   {
     "timestamp": "2024-01-15T10:30:00+00:00",
     "client": { ... }
   }

ðŸ“¡ Test 4: Echo test (POST /api/echo)
âœ… Status: 200
   Response: { ... }

âœ… All tests completed successfully!
```

## Alternative: Using cURL Extension

If you prefer PHP's cURL extension:

```php
$ch = curl_init('https://localhost:8443/');

curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_SSL_VERIFYPEER => true,
    CURLOPT_SSLCERT => 'server-cert.pem',
    CURLOPT_SSLKEY => 'server-key.pem',
    CURLOPT_CAINFO => 'ca-cert.pem',
]);

$response = curl_exec($ch);
curl_close($ch);
```

## Troubleshooting

**Connection refused:**
- Make sure the server is running
- Check the port number

**Certificate verification failed:**
- Ensure all certificates are signed by the same CA
- Check certificate paths are correct
- Verify certificates are not expired

**OpenSSL error:**
- Check if OpenSSL extension is enabled: `php -m | grep openssl`
- Verify certificate file permissions
- Ensure certificate format is correct (PEM)

**Peer certificate verification failed:**
- Server certificate must have 'localhost' in CN or SAN
- CA certificate must be correctly loaded
- Check `verify_peer` and `verify_peer_name` settings
