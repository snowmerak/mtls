# Go mTLS Client Example

A simple HTTP client that connects to mTLS-enabled servers using certificates generated by the mtls tool.

## Prerequisites

1. Go 1.21 or later
2. Generate certificates using mtls tool
3. A running mTLS server (see ../go-server or ../caddy)

## Setup

### 1. Generate Certificates

```bash
# From the mtls project root
./mtls ca create --batch --cn "Example CA" --key-type rsa4096

./mtls cert create --batch \
  --ca ./certs/ca \
  --cn "localhost" \
  --dns "localhost,127.0.0.1" \
  --ip "127.0.0.1" \
  --key-type rsa2048
```

### 2. Start a Server

Choose one:

**Option A: Go Server**
```bash
cd ../go-server
go run main.go
```

**Option B: Caddy Server**
```bash
cd ../caddy
./run.sh
```

### 3. Run the Client

```bash
cd examples/go-client
go run main.go
```

## What the Client Does

The client performs 4 tests against the mTLS server:

1. **Main Endpoint (GET /)** - Gets server info and client certificate verification status
2. **Health Check (GET /health)** - Simple health check endpoint
3. **API Data (GET /api/data)** - Retrieves sample JSON data
4. **Echo Test (POST /api/echo)** - Sends JSON data and receives it back

## Expected Output

```
ðŸ”’ mTLS Go Client
================

ðŸ“¡ Test 1: Main endpoint (GET /)
âœ… Status: 200
   Message: mTLS connection established successfully
   Client Certificate: localhost
   Verified: true
   Server Time: 2025-11-13T12:34:56+09:00

ðŸ“¡ Test 2: Health check (GET /health)
âœ… Status: 200
   Response: OK

ðŸ“¡ Test 3: API data (GET /api/data)
âœ… Status: 200
   Data:
   {
     "data": {
       "count": 3,
       "items": ["item1", "item2", "item3"]
     },
     "status": "success",
     "timestamp": "2025-11-13T12:34:56.789Z"
   }

ðŸ“¡ Test 4: Echo test (POST /api/echo)
âœ… Status: 200
   Response:
   {
     "echo": "{\"message\":\"Hello from mTLS client!\",\"test\":true,\"timestamp\":\"...\"}",
     "received": "2025-11-13T12:34:56.789Z",
     "status": "success"
   }

âœ… All tests completed successfully!
```

## Code Structure

```go
// Load client certificate
cert, _ := tls.LoadX509KeyPair("cert.pem", "key.pem")

// Load CA certificate for server verification
caCert, _ := os.ReadFile("ca-cert.pem")
caCertPool := x509.NewCertPool()
caCertPool.AppendCertsFromPEM(caCert)

// Configure TLS
tlsConfig := &tls.Config{
    Certificates: []tls.Certificate{cert},  // Client cert
    RootCAs:      caCertPool,               // Trusted CAs
}

// Create HTTP client
client := &http.Client{
    Transport: &http.Transport{
        TLSClientConfig: tlsConfig,
    },
}

// Make requests
resp, _ := client.Get("https://localhost:8443")
```

## Testing Different Scenarios

### Test with Invalid Certificate

Try connecting without a client certificate (will fail):

```go
client := &http.Client{
    Transport: &http.Transport{
        TLSClientConfig: &tls.Config{
            RootCAs: caCertPool,
            // No Certificates specified
        },
    },
}
```

### Test with Different Endpoints

Modify the `serverURL` constant to test different servers:

```go
const serverURL = "https://your-server:8443"
```

## Features

- âœ… mTLS client authentication
- âœ… Server certificate verification
- âœ… Multiple endpoint testing
- âœ… JSON request/response handling
- âœ… Pretty-printed JSON output
- âœ… Error handling and logging
- âœ… Configurable timeouts

## Troubleshooting

### Connection Refused
- Make sure the server is running on port 8443
- Check that you're using the correct server URL

### Certificate Verification Failed
- Ensure certificates were generated with the correct CA
- Check that the CA certificate is correctly loaded
- Verify certificate paths are correct

### TLS Handshake Failed
- Make sure both client and server are using compatible TLS versions
- Check that the certificates are not expired
- Verify that the CA certificate is trusted by both sides
